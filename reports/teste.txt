IF OBJECT_ID('tempdb..#TempTable') IS NOT NULL DROP TABLE #TempTable IF OBJECT_ID('tempdb..#WorkTable') IS NOT NULL DROP TABLE #WorkTable CREATE TABLE #TempTable( CODIGO INT, EXTRACTED_VALUE VARCHAR(255), OBS VARCHAR(MAX)) CREATE TABLE #WorkTable ( CODIGO INT, REMAINING_VALUES VARCHAR(MAX), OBS VARCHAR(MAX) ) INSERT INTO #WorkTable (CODIGO, REMAINING_VALUES, OBS) SELECT CODIGO, CASE WHEN CHARINDEX('GRUPO=', OBS) > 0 AND CHARINDEX('.', OBS) > CHARINDEX('GRUPO=', OBS) + 6 AND CHARINDEX('.', OBS) - CHARINDEX('GRUPO=', OBS) - 6 > 0 THEN SUBSTRING(OBS, CHARINDEX('GRUPO=', OBS) + 6, CHARINDEX('.', OBS) - CHARINDEX('GRUPO=', OBS) - 6) ELSE '' END AS REMAINING_VALUES, OBS FROM FUNCIONARIO WHERE OBS LIKE '%GRUPO=%.%' AND CHARINDEX('GRUPO=', OBS) > 0 AND CHARINDEX('.', OBS) > CHARINDEX('GRUPO=', OBS) + 6; WHILE EXISTS (SELECT 1 FROM #WorkTable WHERE LEN(LTRIM(RTRIM(REMAINING_VALUES))) > 0) BEGIN INSERT INTO #TempTable (CODIGO, EXTRACTED_VALUE, OBS) SELECT CODIGO, CASE WHEN CHARINDEX(',', REMAINING_VALUES) > 0 THEN LTRIM(RTRIM(LEFT(REMAINING_VALUES, CHARINDEX(',', REMAINING_VALUES) - 1))) ELSE LTRIM(RTRIM(REMAINING_VALUES)) END AS EXTRACTED_VALUE, OBS FROM #WorkTable WHERE LEN(LTRIM(RTRIM(REMAINING_VALUES))) > 0 AND LEN(LTRIM(RTRIM( CASE WHEN CHARINDEX(',', REMAINING_VALUES) > 0 THEN LEFT(REMAINING_VALUES, CHARINDEX(',', REMAINING_VALUES) - 1) ELSE REMAINING_VALUES END ))) > 0; UPDATE #WorkTable SET REMAINING_VALUES = CASE WHEN CHARINDEX(',', REMAINING_VALUES) > 0 THEN LTRIM(RTRIM(SUBSTRING(REMAINING_VALUES, CHARINDEX(',', REMAINING_VALUES) + 1, LEN(REMAINING_VALUES)))) ELSE '' END WHERE LEN(LTRIM(RTRIM(REMAINING_VALUES))) > 0; DELETE FROM #WorkTable WHERE LEN(LTRIM(RTRIM(REMAINING_VALUES))) = 0; END SELECT CODIGO, EXTRACTED_VALUE, OBS FROM #TempTable WHERE LEN(LTRIM(RTRIM(EXTRACTED_VALUE))) > 0 ORDER BY CODIGO, EXTRACTED_VALUE

